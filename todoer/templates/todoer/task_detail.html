{% extends 'todoer/layouts/base.html' %}
{% block content %}
<main class="container py-5">
    <section class="card card-body bg-dark text-light">
        <h2>{{ task.title }}</h2>
        <p>{{ task.description }}</p>
        <p><strong>Creado:</strong> {{ task.created_at }}</p>
        <p><strong>Última edición:</strong> {{ task.updated_at }}</p>
        <h3>
            <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse"
                data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
                Histórico de ediciones
            </button>
        </h3>

        <div class="collapse mt-3" id="historyCollapse">
            <ul class="list-group">
                {% for entry in history %}
                <li class="list-group-item bg-dark text-light">

                    {% if entry.action_flag == 1 %}
                    ➕
                    {% elif entry.action_flag == 2 %}
                    ✏️
                    {% elif entry.action_flag == 3 %}
                    ❌
                    {% endif %}

                    {{ entry.action_time }} – {{ entry.user.username }} – {{ entry.get_action_flag_display }}

                    {% if entry.parsed_message %}
                    {% if entry.parsed_message.0.changed %}
                    <br><small>Campos modificados: {{ entry.parsed_message.0.changed.fields|join:", " }}</small>
                    {% else %}
                    <br><small>{{ entry.parsed_message }}</small>
                    {% endif %}
                    {% endif %}
                </li>
                {% empty %}
                <li class="list-group-item bg-dark text-light">Sin ediciones registradas</li>
                {% endfor %}
            </ul>
        </div>

        <p><strong>Estado:</strong>
            {% if task.completed %} ✅ Completada {% else %} ⏳ Pendiente {% endif %}
        </p>
        <p><strong>Grupo:</strong>
            {% if task.group %} {{ task.group.name }} {% else %} Privada {% endif %}
        </p>

        <div class="mt-3">
            <a href="{% url 'todoer:edit_task' task.id %}" class="btn btn-warning">Editar</a>
            <a href="{% url 'todoer:task_list' %}" class="btn btn-secondary">Volver</a>
        </div>
    </section>
</main>
{% endblock %}